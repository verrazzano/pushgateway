# Copyright (C) 2020, 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

FROM container-registry.oracle.com/os/oraclelinux:8-slim@sha256:fcbff2e818ff95db116820aa451b6bf11b6e1cdf4804b1f12c65588237bb71d3 as build_base

RUN microdnf update \
    && microdnf install -y git gcc make tar golang-1.14.12-1.module+el8.3.0+7887+1b2c3dab.x86_64 \
    && microdnf clean all \
    && go version

# Compile to /usr/bin
ENV GOBIN=/usr/bin

# Set go path
ENV GOPATH=/go

# Need to use specific WORKDIR to match alertmanager's source packages
WORKDIR /root/go/src/github.com/prometheus/pushgateway

COPY . .

ENV GO111MODULE=on
RUN make common-build common-test

FROM container-registry.oracle.com/os/oraclelinux:8-slim@sha256:fcbff2e818ff95db116820aa451b6bf11b6e1cdf4804b1f12c65588237bb71d3

COPY --from=build_base --chown=nobody:nobody /root/go/src/github.com/prometheus/pushgateway/pushgateway /bin/pushgateway

# Add license files to the image
COPY LICENSE NOTICE README.md THIRD_PARTY_LICENSES.txt /license/

# in OL8, user "nobody" has UID 99; specifying user by UID to facilitate K8s
# confirming this is not running as root
USER       99
EXPOSE     9091
ENV        VERRAZZANO_PUSHGATEWAY_IGNORE_TYPES=true
ENV        VERRAZZANO_PUSHGATEWAY_200_COMPATIBILITY=true
ENTRYPOINT [ "/bin/pushgateway" ]
CMD [ "--log.level=warn", "--push.disable-consistency-check" ]
